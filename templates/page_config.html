<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>预约配置 - 我去抢个座</title>
  <link rel="shortcut icon" href="/static/images/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon/favicon-16x16.png">
  <link rel="manifest" href="/static/images/favicon/site.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    html,
    body {
      /* height: 100%; */
      /* Body height will be auto */
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #ffffff;
      /* Default for html, body will have its own */
    }

    html {
      height: 100%;
      /* HTML element fills the iframe */
    }

    body {
      height: auto;
      /* Override height from any potential html,body rule */
      /* overflow-y: auto; */
      /* Removed, scrolling handled by index.html's main-content */

      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
      padding-bottom: 5rem;
      /* This should now create space correctly */
      background-color: #ffffff;
      /* Explicit light mode background for body */
      margin: 0;
      /* ensure no default margin */
    }

    .config-form-container {
      background-color: #ffffff;
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 700px;
      /* Max width for the form */
      margin-top: 1rem;
      /* Reduced top margin */
    }

    .form-input,
    .form-select,
    .form-textarea {
      border: 1px solid #D1D5DB;
      /* Gray-300 */
      border-radius: 8px;
      padding: 0.75rem 1rem;
      width: 100%;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      background-color: #f9fafb;
      /* Lighter background for inputs */
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: #4A90E2;
      /* Primary blue */
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25);
      outline: none;
      background-color: #ffffff;
    }

    .form-label {
      font-weight: 600;
      color: #374151;
      /* Gray-700 */
      margin-bottom: 0.5rem;
      display: block;
    }

    .submit-button {
      background-color: #4A90E2;
      /* Blue for submit, matching the app theme */
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      width: 100%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .submit-button:hover {
      background-color: #357ABD;
      /* Darker blue */
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .submit-button:disabled {
      background-color: #d1d5db;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .view-result-button {
      background-color: #10B981;
      /* Green color matching status page */
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: bold;
      width: 100%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .view-result-button:hover {
      background-color: #059669;
      /* Darker green on hover */
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }
    
    .view-result-button:disabled {
      background-color: #d1d5db;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .buttons-container {
      display: flex;
      gap: 1rem;
      width: 100%;
    }

    .error-message {
      color: #DC2626;
      /* Red-600 */
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .config-form-container {
        margin-top: 0.5rem;
        padding: 1rem 1.5rem;
      }
    }

    .input-icon-wrapper {
      position: relative;
    }

    .input-icon-wrapper .fa-question-circle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      /* Gray-400 */
      cursor: help;
    }

    /* Styles for the new mode switch */
    .mode-switch-container {
      display: flex;
      position: relative;
      background-color: #e5e7eb;
      /* gray-200 */
      border-radius: 8px;
      /* Square corners */
      padding: 0.25rem;
      /* p-1 */
    }

    .mode-switch-option {
      flex: 1;
      text-align: center;
      padding: 0.5rem 0.75rem;
      /* py-2 px-3 */
      border-radius: 8px;
      /* Square corners */
      cursor: pointer;
      z-index: 10;
      transition: color 0.3s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      /* text-sm */
      line-height: 1.25rem;
      color: #4b5563;
      /* gray-600 default */
    }

    @media (min-width: 640px) {

      /* sm: */
      .mode-switch-option {
        font-size: 1rem;
        /* text-base */
        line-height: 1.5rem;
        padding: 0.5rem 1rem;
        /* py-2 px-4 */
      }
    }


    .mode-switch-option .fas {
      margin-right: 0.25rem;
      /* mr-1 */
    }

    @media (min-width: 640px) {

      /* sm: */
      .mode-switch-option .fas {
        margin-right: 0.5rem;
        /* sm:mr-2 */
      }
    }

    .mode-switch-slider {
      position: absolute;
      top: 0.25rem;
      /* top-1 */
      left: 0.25rem;
      /* left-1 */
      bottom: 0.25rem;
      /* bottom-1 */
      /* height will be auto due to top/bottom settings */
      width: calc(50% - 0.25rem);
      /* Adjusts for padding, assuming 2 options */
      background-color: #3b82f6;
      /* blue-600 */
      border-radius: 8px;
      /* Square corners */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      /* shadow-md */
      transition: transform 0.3s ease-in-out;
      z-index: 5;
    }

    /* 执行时间开关的样式，与模式开关相同 */
    .execution-time-switch-slider {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      bottom: 0.25rem;
      width: calc(50% - 0.25rem);
      background-color: #3b82f6;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.3s ease-in-out;
      z-index: 5;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Icon colors for mode switch */
    .mode-switch-option .fas.icon-selected {
      color: white;
    }

    .mode-switch-option .fas.icon-unselected {
      color: #6b7280;
      /* Tailwind gray-500 */
    }

    /* Hover effects for form elements */
    .form-input:hover,
    .form-select:hover,
    .form-textarea:hover {
      border-color: #9CA3AF;
      /* gray-400 for a subtle hover */
    }

    /* Fieldset and Legend styling */
    fieldset {
      border: 1px solid #e5e7eb;
      /* gray-200 */
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    legend {
      font-size: 1.125rem;
      /* text-lg */
      font-weight: 600;
      color: #1f2937;
      /* gray-800 */
      padding: 0 0.5rem;
      /* margin-left: 0.5rem; Removed to let flex alignment handle it with padding */
      display: flex;
      align-items: center;
    }

    legend .fas {
      margin-right: 0.5rem;
      color: #4A90E2;
      /* Primary blue, or adjust per section */
    }

    /* Library loading spinner */
    .loader-spinner {
      display: none;
      /* Hidden by default */
      border: 3px solid #f3f3f3;
      /* Light grey */
      border-top: 3px solid #4A90E2;
      /* Blue */
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin-left: 0.75rem;
      /* Space from select, increased slightly */
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Mode switch text color classes */
    .mode-switch-option.text-selected {
      color: white !important;
      font-weight: 600;
      /* semibold */
    }

    .mode-switch-option.text-unselected {
      color: #4b5563 !important;
      /* gray-600 */
      font-weight: 400;
      /* normal */
    }

    /* --- Dark Mode Styles for Config Page --- */
    html.dark {
      background-color: #1a202c;
      /* Ensure html root also has dark background */
    }

    html.dark body {
      background-color: #1a202c;
      /* Tailwind gray-900 */
      color: #cbd5e0;
      /* Tailwind gray-400 */
    }

    html.dark .config-form-container {
      background-color: #2d3748;
      /* Tailwind gray-800 */
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    html.dark .text-gray-800 {
      /* For main heading */
      color: #e2e8f0;
      /* Tailwind gray-200 */
    }

    html.dark .text-gray-500 {
      /* For sub-headings and placeholder text */
      color: #a0aec0;
      /* Tailwind gray-500 */
    }

    html.dark fieldset {
      border-color: #4a5568;
      /* Tailwind gray-600 */
    }

    html.dark legend {
      color: #e2e8f0;
      /* Tailwind gray-200 */
    }

    html.dark legend .fas {
      color: #63b3ed;
      /* Tailwind blue-400, consistent with welcome page */
    }

    html.dark .form-label {
      color: #cbd5e0;
      /* Tailwind gray-400 */
    }

    html.dark .form-input,
    html.dark .form-select,
    html.dark .form-textarea {
      background-color: #1f2937;
      /* Darker input background */
      border-color: #4a5568;
      /* Tailwind gray-600 for borders */
      color: #e2e8f0;
      /* Light text for input */
    }

    html.dark .form-input::placeholder,
    html.dark .form-textarea::placeholder {
      color: #718096;
      /* Tailwind gray-500 for placeholders */
    }

    html.dark .form-input:focus,
    html.dark .form-select:focus,
    html.dark .form-textarea:focus {
      background-color: #2d3748;
      border-color: #63b3ed;
      /* Lighter blue for focus */
      box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3);
      /* Lighter blue shadow */
    }

    html.dark .input-icon-wrapper .fa-question-circle {
      color: #a0aec0;
      /* Tailwind gray-500 */
    }

    html.dark #clear_time_button {
      color: #a0aec0;
    }

    html.dark #clear_time_button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #cbd5e0;
    }

    html.dark .mode-switch-container {
      background-color: #1f2937;
      /* Darker background for switch */
    }

    /* html.dark .mode-switch-option.text-unselected is already covered by its specific class */
    /* html.dark .mode-switch-option .fas.icon-unselected is already covered by its specific class */
    html.dark .mode-switch-slider {
      background-color: #3182ce;
      /* Tailwind blue-600, consistent with welcome button */
    }

    html.dark .submit-button {
      background-color: #3B82F6;
      /* Tailwind blue-500 */
    }

    html.dark .submit-button:hover {
      background-color: #2563EB;
      /* Tailwind blue-600 */
    }

    html.dark .submit-button:disabled {
      background-color: #4a5568;
      /* Tailwind gray-600 */
      opacity: 0.7;
    }

    html.dark .view-result-button {
      background-color: #059669;
      /* Darker green for dark mode */
    }

    html.dark .view-result-button:hover {
      background-color: #047857;
      /* Even darker green on hover in dark mode */
    }

    html.dark .view-result-button:disabled {
      background-color: #4a5568;
      /* Tailwind gray-600 */
      opacity: 0.7;
    }

    html.dark .error-message {
      color: #f56565;
      /* Tailwind red-500 */
    }

    html.dark .loader-spinner {
      border-top-color: #63b3ed;
      /* Lighter blue for spinner */
    }

    html.dark select option {
      /* Styling for options inside select */
      background-color: #2d3748;
      /* Dark background for dropdown options */
      color: #e2e8f0;
      /* Light text for options */
    }

    /* Style for the time input's calendar picker icon in dark mode */
    html.dark input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    /* For Firefox, the styling is different and often not possible for the icon directly */
    /* Consider a more robust custom solution if cross-browser consistency is critical for this icon */

    /* Text alignment for specific inputs */
    #seat_number {
      /* Seat number text centered */
      text-align: left;
    }

    #lib_id {
      /* Library select: selected text centered */
      text-align: left;
      /* General centering for the select box */
      text-align-last: left;
      /* Specifically for the selected option's displayed text */
    }

    #lib_id option {
      /* Dropdown options remain left-aligned */
      text-align: left;
    }

    /* #time_str (execution time) will use default text alignment (left) */

    /* 改善移动设备上的显示效果 */
    #scheduled_time_input {
      transition: all 0.3s ease;
    }

    #custom_time_input {
      font-size: 1rem;
      text-align: center;
      letter-spacing: 0.5px;
      height: 48px;
    }

    @media (max-width: 640px) {
      fieldset {
        padding: 1rem;
      }

      legend {
        font-size: 1rem;
        padding: 0 0.25rem;
      }

      .mode-switch-option {
        font-size: 0.8rem;
      }

      .mode-switch-option .fas {
        margin-right: 0.25rem;
      }

      #custom_time_input {
        font-size: 0.9rem;
        height: 40px;
      }

      .submit-button {
        padding: 0.6rem 1rem;
      }
    }

    /* 改善时间输入框的显示效果 */
    #scheduled_time_input {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }

    html.dark #scheduled_time_input {
      background-color: #1f2937;
    }

    #custom_time_input {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      font-family: monospace;
    }

    html.dark #custom_time_input {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #e2e8f0;
    }

    /* 改善移动设备上的显示效果 */
    #custom_time_input_container {
      transition: all 0.3s ease;
    }

    #custom_time_input {
      font-size: 1rem;
      text-align: center;
      letter-spacing: 0.5px;
      height: 48px;
    }

    /* 执行时间选项按钮样式 */
    .time-option-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 0.5rem;
      background-color: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .time-option-button:hover {
      background-color: #e5e7eb;
    }

    .time-option-button.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    html.dark .time-option-button {
      background-color: #1f2937;
      border-color: #4a5568;
      color: #d1d5db;
    }

    html.dark .time-option-button:hover {
      background-color: #374151;
    }

    html.dark .time-option-button.active {
      background-color: #3182ce;
      border-color: #3182ce;
      color: white;
    }

    /* 改善时间输入框的显示效果 */
    #custom_time_input_container {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }

    html.dark #custom_time_input_container {
      background-color: #1f2937;
    }

    #custom_time_input {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      font-family: monospace;
    }

    html.dark #custom_time_input {
      background-color: #2d3748;
      border-color: #4a5568;
      color: #e2e8f0;
    }

    @media (max-width: 640px) {
      .time-option-button {
        padding: 0.6rem 0.25rem;
        font-size: 0.75rem;
      }

      .time-option-button .fas {
        margin-right: 0.25rem;
        font-size: 0.8rem;
      }
    }

    /* 执行时间选择器样式 - 滑块风格 */
    .execution-mode-switch-container {
      display: flex;
      position: relative;
      background-color: #e5e7eb;
      border-radius: 8px;
      padding: 0.25rem;
      width: 100%;
    }

    .execution-mode-option {
      flex: 1;
      text-align: center;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10;
      transition: color 0.3s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      line-height: 1.25rem;
      color: #4b5563;
    }

    .execution-mode-option .fas {
      margin-right: 0.25rem;
    }

    .execution-mode-option.text-selected {
      color: white !important;
      font-weight: 600;
    }

    .execution-mode-option.text-unselected {
      color: #4b5563 !important;
      font-weight: 400;
    }

    .execution-mode-option .fas.icon-selected {
      color: white;
    }

    .execution-mode-option .fas.icon-unselected {
      color: #6b7280;
    }

    .execution-mode-slider {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      bottom: 0.25rem;
      width: calc(33.333% - 0.25rem);
      background-color: #3b82f6;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.3s ease-in-out;
      z-index: 5;
    }

    /* 深色模式 */
    html.dark .execution-mode-switch-container {
      background-color: #1f2937;
    }

    html.dark .execution-mode-slider {
      background-color: #3182ce;
    }

    @media (max-width: 640px) {
      .execution-mode-option {
        font-size: 0.7rem;
        padding: 0.5rem 0.25rem;
      }

      .execution-mode-option .fas {
        margin-right: 0.15rem;
        font-size: 0.8rem;
      }
    }

    /* Submission overlay */
    .submission-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .submission-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4A90E2;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    .submission-message {
      color: white;
      font-size: 1.25rem;
      text-align: center;
      max-width: 80%;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      border-radius: 8px;
    }
    
    /* Dark mode styles */
    html.dark .submission-spinner {
      border-color: #1f2937;
      border-top-color: #3182ce;
    }

    /* 成功预约卡片样式 */
    .success-card {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
      border-radius: 20px;
      padding: 1.75rem 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(37, 99, 235, 0.1);
      max-width: 90%;
      width: 420px;
      text-align: center;
      z-index: 10000; /* 确保比所有元素层级高 */
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(37, 99, 235, 0.1);
    }

    .success-card.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .success-card .card-header {
      margin-bottom: 1.25rem;
    }

    .success-card .success-icon {
      font-size: 2.75rem;
      color: #10B981;
      margin-bottom: 0.75rem;
      animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: inline-block;
      filter: drop-shadow(0 4px 6px rgba(16, 185, 129, 0.2));
    }

    .success-card .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1F2937;
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
    }

    .success-card .card-subtitle {
      color: #6B7280;
      font-size: 0.9rem;
      margin-bottom: 1.25rem;
      line-height: 1.4;
    }

    .success-card .info-section {
      background: rgba(37, 99, 235, 0.03);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(37, 99, 235, 0.08);
    }

    .success-card .info-item {
      background-color: white;
      padding: 0.75rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      text-align: left;
      transition: transform 0.2s ease;
      border: 1px solid rgba(37, 99, 235, 0.08);
    }

    .success-card .info-item:last-child {
      margin-bottom: 0;
    }

    .success-card .info-item:hover {
      transform: translateY(-2px);
    }

    .success-card .info-item i {
      font-size: 1.1rem;
      margin-right: 0.75rem;
      color: #3B82F6;
      width: 24px;
      text-align: center;
    }

    .success-card .info-label {
      color: #6B7280;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.2rem;
      display: block;
    }

    .success-card .info-text {
      color: #1F2937;
      font-weight: 600;
      font-size: 1rem;
    }

    .success-card .encouragement {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
      border-radius: 12px;
      color: #2563EB;
      font-style: italic;
      font-weight: 500;
      line-height: 1.5;
      position: relative;
      overflow: hidden;
      font-size: 0.9rem;
    }

    .success-card .encouragement::before {
      content: '"';
      position: absolute;
      top: 0.5rem;
      left: 0.75rem;
      font-size: 2.5rem;
      color: rgba(37, 99, 235, 0.1);
      font-family: serif;
    }

    .success-card .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: #9CA3AF;
      cursor: pointer;
      padding: 0.5rem;
      transition: all 0.2s;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .success-card .close-button:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: #4B5563;
    }

    /* 深色模式适配 */
    html.dark .success-card {
      background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(59, 130, 246, 0.2);
    }

    html.dark .success-card .card-title {
      color: #F3F4F6;
    }

    html.dark .success-card .card-subtitle {
      color: #9CA3AF;
    }

    html.dark .success-card .info-section {
      background: rgba(59, 130, 246, 0.05);
      border-color: rgba(59, 130, 246, 0.1);
    }

    html.dark .success-card .info-item {
      background-color: rgba(31, 41, 55, 0.5);
      border-color: rgba(59, 130, 246, 0.1);
    }

    html.dark .success-card .info-label {
      color: #9CA3AF;
    }

    html.dark .success-card .info-text {
      color: #F3F4F6;
    }

    html.dark .success-card .encouragement {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
      color: #60A5FA;
    }

    html.dark .success-card .close-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    /* 添加弹跳动画效果 */
    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
      }
    }
  </style>
</head>

<body>
  <div class="config-form-container">
    <div class="text-center mb-6">
      <i class="fas fa-cog text-3xl text-blue-600 mb-2"></i>
      <h1 class="text-2xl font-bold text-gray-800">配置预约参数</h1>
      <p class="text-gray-500">请仔细填写以下信息以完成预约。</p>
    </div>

    <form id="config_form" class="space-y-6">
      <fieldset>
        <legend><i class="fas fa-sliders-h"></i>操作模式</legend>
        <div class="mode-switch-container mt-3"> <!-- Added mt-3 for spacing from legend -->
          <input type="radio" name="mode" value="1" id="mode_tomorrow" class="sr-only" checked>
          <input type="radio" name="mode" value="2" id="mode_instant" class="sr-only">

          <label for="mode_tomorrow" id="label_mode_tomorrow" class="mode-switch-option">
            <i class="fas fa-calendar-alt"></i>明日预约
          </label>
          <label for="mode_instant" id="label_mode_instant" class="mode-switch-option">
            <i class="fas fa-bolt"></i>立即抢座
          </label>

          <div class="mode-switch-slider"></div>
        </div>
      </fieldset>

      <fieldset>
        <legend><i class="fas fa-key"></i>身份凭证</legend>
        <div class="mt-3"> <!-- Added mt-3 for spacing from legend -->
          <label for="cookie_str" class="form-label flex items-center"><i
              class="fas fa-cookie-bite mr-2 text-yellow-600"></i>Cookie:</label>
          <div class="input-icon-wrapper">
            <textarea id="cookie_str" name="cookieStr" class="form-textarea py-3" placeholder="请在此处粘贴完整的 Cookie 字符串"
              required style="line-height: 1.5rem; overflow-y: hidden; resize: none;" aria-describedby="cookie_error"></textarea>
            <i class="fas fa-question-circle" title="请从图书馆微信小程序或相关官方途径获取最新的 Cookie 信息。确保包含所有必要字段。" aria-hidden="true"></i>
          </div>
          <p id="cookie_error" class="error-message hidden" role="alert"></p>
        </div>
      </fieldset>

      <fieldset>
        <legend><i class="fas fa-calendar-check"></i>预约详情</legend>
        <div id="time_input_container" class="mt-3"> <!-- Added mt-3 for spacing from legend -->
          <label class="form-label flex items-center"><i class="fas fa-clock mr-2 text-blue-500"></i>执行时间:</label>
          <div class="time-option-container mt-2">
            <div class="execution-mode-switch-container">
              <input type="radio" name="execution_time" value="now" id="execution_now" class="sr-only" checked>
              <input type="radio" name="execution_time" value="default" id="execution_default" class="sr-only">
              <input type="radio" name="execution_time" value="custom" id="execution_custom" class="sr-only">

              <label for="execution_now" id="label_execution_now" class="execution-mode-option">
                <i class="fas fa-bolt"></i>立即执行
              </label>
              <label for="execution_default" id="label_execution_default" class="execution-mode-option">
                <i class="fas fa-stopwatch"></i>21:48
              </label>
              <label for="execution_custom" id="label_execution_custom" class="execution-mode-option">
                <i class="fas fa-clock"></i>定时执行
              </label>

              <div class="execution-mode-slider"></div>
            </div>
          </div>
          <div id="custom_time_input_container" class="mt-3 hidden">
            <input type="time" id="custom_time_input" class="form-input" placeholder="自定义时间" step="1">
            <p class="text-xs text-gray-500 mt-1">请输入您希望执行的时间 (HH:MM:SS)</p>
          </div>
          <input type="hidden" id="time_str" name="timeStr" value="">
          <p id="time_error" class="error-message hidden"></p>
        </div>

        <div class="mt-4">
          <label for="lib_id" class="form-label flex items-center"><i
              class="fas fa-university mr-2 text-indigo-500"></i>阅览室:</label>
          <div class="flex items-center">
            <select id="lib_id" name="libId" class="form-select flex-grow" required aria-describedby="lib_id_error">
              <option value="" disabled selected>请选择阅览室</option>
            </select>
            <span id="lib_loader_spinner" class="loader-spinner" aria-hidden="true"></span>
          </div>
          <p id="lib_id_error" class="error-message hidden" role="alert"></p>
        </div>

        <div class="mt-4">
          <label for="seat_number" class="form-label flex items-center"><i
              class="fas fa-chair mr-2 text-green-500"></i>座位号:</label>
          <input type="text" id="seat_number" name="seatNumber" class="form-input" placeholder="例如: 101 (通常为座位上贴的数字标签)"
            required aria-describedby="seat_number_error">
          <p id="seat_number_error" class="error-message hidden" role="alert"></p>
        </div>
      </fieldset>

      <div id="ws_status_indicator" class="mb-4 text-sm text-gray-600 text-center" role="status" aria-live="polite"></div>

      <div class="buttons-container">
        <button type="submit" id="submit_button" class="submit-button">
          <i class="fas fa-paper-plane mr-2" aria-hidden="true"></i>提交请求
        </button>
        <button type="button" id="view_result_button" class="view-result-button" onclick="showReservationResults(event)">
          <i class="fas fa-eye mr-2" aria-hidden="true"></i>查看结果
        </button>
      </div>
      <div id="form_general_error" class="error-message text-center mt-4 hidden" role="alert"></div>
    </form>
  </div>
  
  <!-- Submission overlay -->
  <div class="submission-overlay" id="submission_overlay">
    <div class="submission-spinner"></div>
    <div class="submission-message">处理中，请稍候...</div>
  </div>
  
  <!-- 成功预约卡片 -->
  <div id="successCard" class="success-card">
    <button class="close-button" onclick="hideSuccessCard()">
      <i class="fas fa-times"></i>
    </button>
    <div class="card-header">
      <i class="fas fa-check-circle success-icon"></i>
      <h2 class="card-title">预约成功</h2>
      <p class="card-subtitle">座位预约成功，祝您学习愉快</p>
    </div>
    <div class="info-section">
      <div class="info-item" style="--item-index: 0">
        <i class="fas fa-clock"></i>
        <div>
          <span class="info-label">预约时间</span>
          <div class="info-text" id="reserveTime">待定</div>
        </div>
      </div>
      <div class="info-item" style="--item-index: 1">
        <i class="fas fa-building"></i>
        <div>
          <span class="info-label">阅览室</span>
          <div class="info-text" id="roomInfo">待定</div>
        </div>
      </div>
      <div class="info-item" style="--item-index: 2">
        <i class="fas fa-chair"></i>
        <div>
          <span class="info-label">座位号</span>
          <div class="info-text" id="seatInfo">待定</div>
        </div>
      </div>
    </div>
    <div class="encouragement" id="encouragementText">
      今天也要加油学习哦！
    </div>
  </div>

  <script>
    const API_URL = '/api';

    const form = document.getElementById('config_form');
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const timeInputContainer = document.getElementById('time_input_container');
    const timeStrInput = document.getElementById('time_str');
    const libIdSelect = document.getElementById('lib_id');
    const cookieStrInput = document.getElementById('cookie_str');
    const seatNumberInput = document.getElementById('seat_number');
    const submitButton = document.getElementById('submit_button');
    const viewResultButton = document.getElementById('view_result_button');
    const formGeneralError = document.getElementById('form_general_error');

    const cookieError = document.getElementById('cookie_error');
    const timeError = document.getElementById('time_error');
    const libIdError = document.getElementById('lib_id_error');
    const seatNumberError = document.getElementById('seat_number_error');

    // Mode Switch Elements
    const modeTomorrowRadio = document.getElementById('mode_tomorrow');
    const modeInstantRadio = document.getElementById('mode_instant');
    const labelModeTomorrow = document.getElementById('label_mode_tomorrow');
    const labelModeInstant = document.getElementById('label_mode_instant');
    const modeSlider = document.querySelector('.mode-switch-slider');

    // 执行时间开关元素
    const executionNowRadio = document.getElementById('execution_now');
    const executionDefaultRadio = document.getElementById('execution_default');
    const executionCustomRadio = document.getElementById('execution_custom');
    const labelExecutionNow = document.getElementById('label_execution_now');
    const labelExecutionDefault = document.getElementById('label_execution_default');
    const labelExecutionCustom = document.getElementById('label_execution_custom');
    const customTimeInputContainer = document.getElementById('custom_time_input_container');

    // Time Clear Button Element
    const clearTimeButton = document.getElementById('clear_time_button');

    // Library Loader Spinner
    const libLoaderSpinner = document.getElementById('lib_loader_spinner');

    // localStorage key
    const LOCAL_STORAGE_KEY = 'igarss_configFormData';

    // These will be replaced by Jinja2 if served as a TemplateResponse
    // Default values for static serving or if Jinja2 variables are not passed
    const TOMORROW_RESERVE_WINDOW_START_STR = "{{ TOMORROW_RESERVE_WINDOW_START_STR | default('19:48:00') }}";
    const TOMORROW_RESERVE_WINDOW_END_STR = "{{ TOMORROW_RESERVE_WINDOW_END_STR | default('23:59:59') }}";

    // Update placeholder/title attributes with actual window times
    document.addEventListener('DOMContentLoaded', () => {
      const timeHintPara = timeInputContainer.querySelector('.text-xs.text-gray-500.mt-1');
      if (timeHintPara) {
        timeHintPara.textContent = `明日预约窗口: ${TOMORROW_RESERVE_WINDOW_START_STR} - ${TOMORROW_RESERVE_WINDOW_END_STR}. 提示：明日预约模式下时间必填；立即抢座模式下可留空或指定时间。`;
      }

      const iconTomorrow = labelModeTomorrow.querySelector('.fas');
      const iconInstant = labelModeInstant.querySelector('.fas');

      // Initialize mode switch label colors, font weight. Icon classes will be set by updateModeSwitchVisuals.
      // labelModeTomorrow.classList.add('text-gray-600', 'font-normal'); 
      // labelModeInstant.classList.add('text-gray-600', 'font-normal'); 
      // Apply new text classes for initialization
      if (modeTomorrowRadio.checked) {
        labelModeTomorrow.classList.add('text-selected');
        labelModeInstant.classList.add('text-unselected');
        if (iconTomorrow) iconTomorrow.className = 'fas fa-calendar-alt icon-selected';
        if (iconInstant) iconInstant.className = 'fas fa-bolt icon-unselected';
      } else { // Instant mode selected
        labelModeInstant.classList.add('text-selected');
        labelModeTomorrow.classList.add('text-unselected');
        if (iconInstant) iconInstant.className = 'fas fa-bolt icon-selected';
        if (iconTomorrow) iconTomorrow.className = 'fas fa-calendar-alt icon-unselected';
      }

      updateModeSwitchVisuals();

      // --- Form Persistence & Theme Initialization --- 
      loadFormDataFromLocalStorage(); // Load general form data first (except libId which needs options)

      if (libLoaderSpinner) libLoaderSpinner.style.display = 'inline-block';
      loadLibraries(); // This will populate libIdSelect and then call applySavedLibId in its finally block

      // Auto-resize textarea for cookie input
      autoResizeTextarea(cookieStrInput);

      // Check WebSocket status
      checkWebSocketStatus();

      // Get initial theme from parent AFTER other DOM setup
      if (window.parent && typeof window.parent.getCurrentTheme === 'function') {
        const currentTheme = window.parent.getCurrentTheme();
        if (window.setAppTheme) window.setAppTheme(currentTheme);
      } else {
        console.warn("Could not get initial theme from parent for page_config.html on DOMContentLoaded");
      }

      // 初始化执行时间选项UI
      updateExecutionTimeVisuals();

      // 设置自定义时间输入框默认值并添加特殊处理
      const customTimeInput = document.getElementById('custom_time_input');
      if (customTimeInput) {
        // 添加失去焦点时处理iOS时间格式
        customTimeInput.addEventListener('blur', function () {
          if (this.value) {
            // 如果缺少秒，自动补全
            const timeParts = this.value.split(':');
            if (timeParts.length === 2) {
              this.value = this.value + ':00';
              console.log("iOS设备时间输入补全秒数:", this.value);
              saveFormDataToLocalStorage();
            }
          }
        });

        customTimeInput.addEventListener('input', saveFormDataToLocalStorage);
        customTimeInput.value = '21:48:00';
      }

      // 检测设备类型，显示提示
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS && customTimeInput) {
        const container = document.getElementById('custom_time_input_container');
        if (container) {
          const iosHint = document.createElement('p');
          iosHint.className = 'text-xs text-yellow-500 mt-1';
          iosHint.innerHTML = '<i class="fas fa-info-circle mr-1"></i>iOS设备提示: 如时间选择器无法选择秒，系统将自动补全为":00"';
          container.appendChild(iosHint);
        }
      }
      
      // 初始化查看结果按钮
      if (viewResultButton) {
        console.log("初始化查看结果按钮");
        
        // 检查是否存在预约结果，否则添加测试数据（仅用于开发调试）
        if (!localStorage.getItem('lastReservationResult')) {
          console.log("添加测试预约数据用于调试");
          addTestData();
        }
        
        updateViewResultButtonState();
        
        // 为按钮添加点击事件（除了onclick属性外的额外保障）
        viewResultButton.addEventListener('click', function(e) {
          console.log("查看结果按钮被点击");
          // 阻止事件冒泡
          e.stopPropagation();
          showReservationResults(e);
        });
      } else {
        console.error("找不到查看结果按钮元素");
      }
    });

    function autoResizeTextarea(textarea) {
      if (!textarea) return;
      textarea.style.height = 'auto'; // Reset height
      textarea.style.height = textarea.scrollHeight + 'px'; // Set to scroll height
    }

    // Initialize WebSocket variable
    let socket = null;

    function checkWebSocketStatus() {
        const wsStatusIndicator = document.getElementById('ws_status_indicator');
        if (!wsStatusIndicator) return;

        wsStatusIndicator.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>正在检测 WebSocket 服务状态...';

        // 检查是否是iOS设备
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        // iOS设备特殊处理
        if (isIOS) {
            console.log("检测到iOS设备，采用特殊WebSocket检测处理");
            setTimeout(() => {
                wsStatusIndicator.innerHTML = '<i class="fas fa-info-circle text-blue-500 mr-1"></i>iOS设备: WebSocket可能正常 (提交功能可用)';
            }, 500);
            return;
        }

        // Determine WebSocket protocol (ws or wss)
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = wsProtocol + "//" + window.location.host + "/ws_test_connection";

        try {
            if (socket) {
                socket.close();
            }
            socket = new WebSocket(wsUrl);
        } catch (e) {
            console.error("WebSocket instantiation failed:", e);
            wsStatusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>WebSocket 服务连接失败 (无法创建)。';
            return;
        }

        // 设置连接超时
        const connectionTimeout = setTimeout(() => {
            if (socket && socket.readyState !== WebSocket.OPEN) {
                wsStatusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>WebSocket 连接超时，但提交功能可能仍然可用。';
                socket.close();
            }
        }, 5000);

        socket.onopen = function () {
            clearTimeout(connectionTimeout);
            wsStatusIndicator.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>WebSocket 服务连接正常。';
            socket.close();
        };

        socket.onerror = function (event) {
            clearTimeout(connectionTimeout);
            console.error("WebSocket Error: ", event);
            wsStatusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>WebSocket 服务连接失败。';
        };

        socket.onclose = function (event) {
            clearTimeout(connectionTimeout);
            if (!event.wasClean) {
                console.warn('WebSocket connection closed uncleanly.', event);
                if (wsStatusIndicator.innerHTML.includes('正在检测')) {
                    wsStatusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>WebSocket 服务无法建立连接。';
                }
            }
        };
    }

    // Add WebSocket cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close(1000, 'Page navigation');
        }
    });

    function saveFormDataToLocalStorage() {
      const formData = {
        mode: document.querySelector('input[name="mode"]:checked').value,
        cookieStr: cookieStrInput.value,
        timeStr: timeStrInput.value,
        libId: libIdSelect.value,
        seatNumber: seatNumberInput.value
      };
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(formData));
    }

    function loadFormDataFromLocalStorage() {
      const savedDataString = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (savedDataString) {
        try {
          const savedData = JSON.parse(savedDataString);

          // Set mode
          if (savedData.mode === '1') {
            modeTomorrowRadio.checked = true;
          } else if (savedData.mode === '2') {
            modeInstantRadio.checked = true;
          }
          // Important: After setting radio, update visuals like slider and text color
          updateModeSwitchVisuals();

          cookieStrInput.value = savedData.cookieStr || '';

          // 处理执行时间选项
          if (savedData.timeStr === '00:00:01') {
            // 立即执行
            executionNowRadio.checked = true;
          } else if (savedData.timeStr === '21:48:00') {
            // 默认时间执行
            executionDefaultRadio.checked = true;
          } else if (savedData.timeStr) {
            // 自定义时间执行
            executionCustomRadio.checked = true;
            // 设置自定义时间输入框
            const customTimeInput = document.getElementById('custom_time_input');
            if (customTimeInput) customTimeInput.value = savedData.timeStr;
          } else {
            // 如果没有时间值，默认选择立即执行
            executionNowRadio.checked = true;
          }
          updateExecutionTimeVisuals();

          // For libId, ensure it's set after libraries are loaded if it depends on dynamic options
          // We will call applySavedLibId separately after loadLibraries completes.
          seatNumberInput.value = savedData.seatNumber || '';

        } catch (e) {
          console.error("Error parsing saved form data from localStorage:", e);
          localStorage.removeItem(LOCAL_STORAGE_KEY); // Clear corrupted data
        }
      }
    }

    function applySavedLibId() {
      const savedDataString = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (savedDataString) {
        try {
          const savedData = JSON.parse(savedDataString);
          if (savedData.libId && libIdSelect.options.length > 1) { // Ensure options are loaded
            // Check if the saved libId exists in the current options
            let optionExists = false;
            for (let i = 0; i < libIdSelect.options.length; i++) {
              if (libIdSelect.options[i].value === savedData.libId) {
                optionExists = true;
                break;
              }
            }
            if (optionExists) {
              libIdSelect.value = savedData.libId;
            } else {
              console.warn(`Saved Lib ID ${savedData.libId} not found in current options.`);
            }
          }
        } catch (e) {
          console.error("Error applying saved Lib ID:", e);
        }
      }
    }

    function generateClientId() {
      return 'client-' + Date.now() + '-' + Math.random().toString(36).substring(2, 15);
    }

    function toggleTimeInput() {
      const selectedMode = document.querySelector('input[name="mode"]:checked').value;
      if (selectedMode === '1') { // Tomorrow reservation
        timeStrInput.required = true;
        timeStrInput.placeholder = "例如: 19:48:00";
      } else { // Instant booking
        timeStrInput.required = false;
        timeStrInput.placeholder = "留空则立即执行, 或输入 HH:MM:SS";
      }
    }

    function updateModeSwitchVisuals() {
      const iconTomorrow = labelModeTomorrow.querySelector('.fas');
      const iconInstant = labelModeInstant.querySelector('.fas');

      if (modeTomorrowRadio.checked) {
        modeSlider.style.transform = 'translateX(0%)';

        // labelModeTomorrow.classList.add('text-white', 'font-semibold');
        // labelModeTomorrow.classList.remove('text-gray-600', 'font-normal');
        labelModeTomorrow.classList.add('text-selected');
        labelModeTomorrow.classList.remove('text-unselected');
        if (iconTomorrow) {
          iconTomorrow.classList.add('icon-selected');
          iconTomorrow.classList.remove('icon-unselected');
        }

        // labelModeInstant.classList.add('text-gray-600', 'font-normal');
        // labelModeInstant.classList.remove('text-white', 'font-semibold');
        labelModeInstant.classList.add('text-unselected');
        labelModeInstant.classList.remove('text-selected');
        if (iconInstant) {
          iconInstant.classList.add('icon-unselected');
          iconInstant.classList.remove('icon-selected');
        }
      } else { // Instant mode selected
        modeSlider.style.transform = 'translateX(100%)';

        labelModeInstant.classList.add('text-selected');
        labelModeInstant.classList.remove('text-unselected');
        if (iconInstant) {
          iconInstant.classList.add('icon-selected');
          iconInstant.classList.remove('icon-unselected');
        }

        // labelModeTomorrow.classList.add('text-gray-600', 'font-normal');
        // labelModeTomorrow.classList.remove('text-white', 'font-semibold');
        labelModeTomorrow.classList.add('text-unselected');
        labelModeTomorrow.classList.remove('text-selected');
        if (iconTomorrow) {
          iconTomorrow.classList.add('icon-unselected');
          iconTomorrow.classList.remove('icon-selected');
        }
      }
      toggleTimeInput();
    }

    function updateExecutionTimeVisuals() {
      const iconNow = labelExecutionNow.querySelector('.fas');
      const iconDefault = labelExecutionDefault.querySelector('.fas');
      const iconCustom = labelExecutionCustom.querySelector('.fas');
      const slider = document.querySelector('.execution-mode-slider');

      // 重置所有样式
      [labelExecutionNow, labelExecutionDefault, labelExecutionCustom].forEach(label => {
        label.classList.remove('text-selected');
        label.classList.add('text-unselected');
      });

      [iconNow, iconDefault, iconCustom].forEach(icon => {
        if (icon) {
          icon.classList.remove('icon-selected');
          icon.classList.add('icon-unselected');
        }
      });

      // 隐藏自定义时间输入框
      if (customTimeInputContainer) {
        customTimeInputContainer.classList.add('hidden');
      }

      if (executionNowRadio.checked) {
        // 立即执行
        slider.style.transform = 'translateX(0%)';
        labelExecutionNow.classList.add('text-selected');
        labelExecutionNow.classList.remove('text-unselected');
        if (iconNow) {
          iconNow.classList.add('icon-selected');
          iconNow.classList.remove('icon-unselected');
        }
      } else if (executionDefaultRadio.checked) {
        // 默认时间执行
        slider.style.transform = 'translateX(100%)';
        labelExecutionDefault.classList.add('text-selected');
        labelExecutionDefault.classList.remove('text-unselected');
        if (iconDefault) {
          iconDefault.classList.add('icon-selected');
          iconDefault.classList.remove('icon-unselected');
        }
      } else if (executionCustomRadio.checked) {
        // 自定义时间执行
        slider.style.transform = 'translateX(200%)';
        labelExecutionCustom.classList.add('text-selected');
        labelExecutionCustom.classList.remove('text-unselected');
        if (iconCustom) {
          iconCustom.classList.add('icon-selected');
          iconCustom.classList.remove('icon-unselected');
        }
        // 显示自定义时间输入框
        if (customTimeInputContainer) {
          customTimeInputContainer.classList.remove('hidden');
        }
      }
    }

    async function loadLibraries() {
      try {
        const response = await fetch(`${API_URL}/mappings`);
        if (!response.ok) {
          let errorDetail = `HTTP error! status: ${response.status}`;
          try { const errData = await response.json(); errorDetail = errData.detail || errorDetail; } catch (e) { }
          throw new Error(errorDetail);
        }
        const data = await response.json();

        libIdSelect.innerHTML = '<option value="" disabled selected>请选择阅览室</option>'; // Reset before populating
        if (data.rooms && Object.keys(data.rooms).length > 0) {
          for (const [id, name] of Object.entries(data.rooms)) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            libIdSelect.appendChild(option);
          }
        } else {
          libIdError.textContent = '未加载到阅览室数据，或数据为空。';
          libIdError.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Failed to load libraries:', error);
        libIdSelect.innerHTML = '<option value="" disabled selected>加载阅览室失败</option>';
        libIdError.textContent = `无法加载阅览室列表: ${error.message}`;
        libIdError.classList.remove('hidden');
      } finally {
        if (libLoaderSpinner) libLoaderSpinner.style.display = 'none';
        // After libraries are loaded and select is populated, try to apply saved libId
        applySavedLibId();
        // Also, ensure that if libId was just set from localStorage, we save again to capture it if not already event-triggered.
        // However, individual event listeners should handle this better.
      }
    }

    function validateTimeFormat(timeStr) {
      return /^\d{2}:\d{2}(:\d{2})?$/.test(timeStr);
    }

    function validateForm() {
      let isValid = true;
      [cookieError, timeError, libIdError, seatNumberError, formGeneralError].forEach(el => { el.textContent = ''; el.classList.add('hidden'); });

      if (!cookieStrInput.value.trim()) {
        cookieError.textContent = 'Cookie 不能为空。';
        cookieError.classList.remove('hidden');
        isValid = false;
      }

      const selectedMode = document.querySelector('input[name="mode"]:checked').value;
      const customTimeInput = document.getElementById('custom_time_input');

      // 更新隐藏的时间字段值
      if (selectedMode === '1') { // 明日预约模式
        if (executionNowRadio.checked) {
          // 立即执行，设置特殊值
          timeStrInput.value = '00:00:01';
        } else if (executionDefaultRadio.checked) {
          // 默认时间
          timeStrInput.value = '21:48:00';
        } else if (executionCustomRadio.checked) {
          // 自定义时间
          if (customTimeInput && customTimeInput.value) {
            // 处理iOS设备时间输入格式问题
            timeStrInput.value = processTimeInput(customTimeInput.value);
          } else {
            timeError.textContent = '请输入自定义时间。';
            timeError.classList.remove('hidden');
            isValid = false;
            return isValid;
          }
        }
      } else { // 立即抢座模式
        if (executionNowRadio.checked) {
          // 立即执行
          timeStrInput.value = '';
        } else if (executionDefaultRadio.checked) {
          // 默认时间
          timeStrInput.value = '21:48:00';
        } else if (executionCustomRadio.checked) {
          // 自定义时间
          if (customTimeInput && customTimeInput.value) {
            // 处理iOS设备时间输入格式问题
            timeStrInput.value = processTimeInput(customTimeInput.value);
          } else {
            timeError.textContent = '请输入自定义时间。';
            timeError.classList.remove('hidden');
            isValid = false;
            return isValid;
          }
        }
      }

      if (!libIdSelect.value) {
        libIdError.textContent = '请选择一个阅览室。';
        libIdError.classList.remove('hidden');
        isValid = false;
      }

      if (!seatNumberInput.value.trim()) {
        seatNumberError.textContent = '座位号不能为空。';
        seatNumberError.classList.remove('hidden');
        isValid = false;
      }
      return isValid;
    }

    // 处理时间输入，特别是处理iOS设备上没有秒的问题
    function processTimeInput(timeValue) {
      if (!timeValue) return '';

      // 检查是否为iOS设备
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

      // 检查时间格式
      const timeParts = timeValue.split(':');

      if (timeParts.length === 2) {
        // 只有时和分，没有秒（iOS设备常见）
        console.log("检测到iOS格式时间输入，自动补全秒数");
        return timeValue + ':00';
      } else if (timeParts.length === 3) {
        // 已经是完整格式，包含秒
        return timeValue;
      } else {
        // 异常格式，返回原值
        console.warn("时间格式异常:", timeValue);
        return timeValue;
      }
    }

    form.addEventListener('submit', async function (event) {
      event.preventDefault();
      if (!validateForm()) return;

      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
      formGeneralError.classList.add('hidden');
      
      // Show submission overlay
      document.getElementById('submission_overlay').style.display = 'flex';

      // Show spinner for library loading during form submission as well, if needed, though it might be confusing.
      // For now, only on initial load.
      if (libLoaderSpinner && libIdSelect.value === "") { // If lib not selected, maybe show spinner - better to handle in loadLibraries
        // libLoaderSpinner.style.display = 'inline-block'; 
      }

      const formData = new FormData(form);
      const data = {
        mode: parseInt(formData.get('mode')),
        cookieStr: formData.get('cookieStr'),
        timeStr: formData.get('timeStr').trim(),
        libId: parseInt(formData.get('libId')),
        seatNumber: formData.get('seatNumber'),
        clientId: generateClientId()
      };

      try {
        const response = await fetch(`${API_URL}/submit_request`, { // Corrected URL
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) { // Reverted to original error handling
          const errorData = await response.json().catch(() => ({ detail: '请求失败，无法解析错误信息。' }));
          throw new Error(errorData.detail || `HTTP error ${response.status}`);
        }

        // 请求已提交，但不立即标记为成功
        // 预约结果将在状态页中确认后再保存
        
        // 通知父页面请求已提交成功（用于导航控制）
        if (window.parent && typeof window.parent.notifySubmissionSuccess === 'function') {
          window.parent.notifySubmissionSuccess(data.clientId);
        }

      } catch (error) {
        console.error('Submission failed:', error);
        formGeneralError.textContent = `提交失败: ${error.message}`;
        formGeneralError.classList.remove('hidden');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>提交请求';
        // Hide submission overlay
        document.getElementById('submission_overlay').style.display = 'none';
      }
    });

    // modeRadios.forEach(radio => radio.addEventListener('change', toggleTimeInput)); 

    // Event listeners for new mode switch
    modeTomorrowRadio.addEventListener('change', () => { updateModeSwitchVisuals(); saveFormDataToLocalStorage(); });
    modeInstantRadio.addEventListener('change', () => { updateModeSwitchVisuals(); saveFormDataToLocalStorage(); });

    // Event listeners for other inputs to save data
    cookieStrInput.addEventListener('input', () => {
      saveFormDataToLocalStorage();
      autoResizeTextarea(cookieStrInput); // Auto-resize on input
    });
    //timeStrInput.addEventListener('input', saveFormDataToLocalStorage);
    libIdSelect.addEventListener('change', saveFormDataToLocalStorage);
    seatNumberInput.addEventListener('input', saveFormDataToLocalStorage);

    // 执行时间选择器的事件监听
    executionNowRadio.addEventListener('change', () => {
      updateExecutionTimeVisuals();
      saveFormDataToLocalStorage();
    });

    executionDefaultRadio.addEventListener('change', () => {
      updateExecutionTimeVisuals();
      saveFormDataToLocalStorage();
    });

    executionCustomRadio.addEventListener('change', () => {
      updateExecutionTimeVisuals();
      saveFormDataToLocalStorage();
    });

    // Function to set theme (called by parent)
    window.setAppTheme = function (theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    };

    // 更新查看结果按钮状态
    function updateViewResultButtonState() {
      try {
        const reservationData = localStorage.getItem('lastReservationResult');
        const hasSuccessfulReservation = reservationData !== null && 
                                        JSON.parse(reservationData).isSuccess === true;
        
        viewResultButton.disabled = !hasSuccessfulReservation;
        
        if (hasSuccessfulReservation) {
          viewResultButton.title = "查看最近的预约结果";
        } else {
          viewResultButton.title = "暂无成功的预约结果";
        }
      } catch (e) {
        console.error("更新结果按钮状态出错:", e);
        viewResultButton.disabled = true;
        viewResultButton.title = "无法检索预约结果";
      }
    }

    // 测试函数 - 用于向localStorage添加测试数据
    function addTestData() {
      const testData = {
        roomName: "测试阅览室",
        seatNumber: "测试座位号",
        timeInfo: new Date().toLocaleString('zh-CN'),
        timestamp: new Date().getTime(),
        isSuccess: true // 标记为成功的预约
      };
      localStorage.setItem('lastReservationResult', JSON.stringify(testData));
      console.log("测试数据已添加:", testData);
      updateViewResultButtonState();
    }

    // 显示成功卡片
    function showSuccessCard(roomName, seatNumber, timeInfo) {
      console.log("显示成功卡片:", roomName, seatNumber, timeInfo);
      const successCard = document.getElementById('successCard');
      if (!successCard) {
        console.error("找不到成功卡片元素!");
        return;
      }
      
      const roomInfoEl = document.getElementById('roomInfo');
      const seatInfoEl = document.getElementById('seatInfo');
      const timeInfoEl = document.getElementById('reserveTime');
      const encouragementEl = document.getElementById('encouragementText');

      // 设置卡片内容
      if (roomInfoEl) roomInfoEl.textContent = roomName || '未知';
      if (seatInfoEl) seatInfoEl.textContent = seatNumber || '未知';
      if (timeInfoEl) timeInfoEl.textContent = timeInfo || new Date().toLocaleString('zh-CN');
      if (encouragementEl) encouragementEl.textContent = getRandomEncouragement();

      // 显示卡片
      console.log("添加show类显示卡片");
      successCard.classList.add('show');

      // 通过延时添加点击监听器，确保当前事件循环完成
      setTimeout(() => {
        // 添加点击背景关闭功能
        document.addEventListener('click', handleOutsideClick);
        
        // 添加ESC键关闭功能
        document.addEventListener('keydown', handleEscKey);
      }, 100);
    }

    // 处理卡片外部点击
    function handleOutsideClick(e) {
      const successCard = document.getElementById('successCard');
      if (!successCard) return;
      
      // 检查点击是否在卡片外部且不是查看结果按钮
      const viewResultButton = document.getElementById('view_result_button');
      if (e.target !== successCard && 
          !successCard.contains(e.target) && 
          e.target !== viewResultButton && 
          !viewResultButton.contains(e.target)) {
        hideSuccessCard();
      }
    }

    // 处理ESC键关闭
    function handleEscKey(e) {
      if (e.key === 'Escape') {
        hideSuccessCard();
      }
    }

    // 隐藏成功卡片
    function hideSuccessCard() {
      console.log("隐藏成功卡片");
      const successCard = document.getElementById('successCard');
      if (successCard) {
        successCard.classList.remove('show');
        
        // 移除事件监听器
        document.removeEventListener('click', handleOutsideClick);
        document.removeEventListener('keydown', handleEscKey);
      }
    }

    // 显示预约结果卡片
    function showReservationResults(e) {
      // 阻止事件冒泡
      if (e) e.stopPropagation();
      
      console.log("显示预约结果函数被调用");
      const reservationData = localStorage.getItem('lastReservationResult');
      if (!reservationData) {
        console.log("没有找到预约结果数据");
        alert("暂无预约结果，请先成功预约座位。");
        return;
      }
      
      try {
        console.log("尝试解析预约数据:", reservationData);
        const data = JSON.parse(reservationData);
        // 检查是否是成功的预约
        if (data.isSuccess === true) {
          showSuccessCard(data.roomName, data.seatNumber, data.timeInfo);
        } else {
          alert("没有成功的预约记录。");
        }
      } catch (e) {
        console.error('Error loading reservation result:', e);
        alert('无法加载预约结果。');
      }
    }

    // 保存预约结果到本地存储
    function saveReservationResult(roomName, seatNumber, timeInfo) {
      const reservationData = {
        roomName: roomName,
        seatNumber: seatNumber,
        timeInfo: timeInfo || new Date().toLocaleString('zh-CN'),
        timestamp: new Date().getTime(),
        isSuccess: true // 标记为成功的预约
      };
      localStorage.setItem('lastReservationResult', JSON.stringify(reservationData));
      updateViewResultButtonState();
    }

    // 随机鼓励语句数组
    const encouragements = [
      "今天也要加油学习哦！✨",
      "知识就是力量，继续前进吧！💪",
      "一步一个脚印，你正在变得更强！🌟",
      "保持专注，你一定能实现目标！🎯",
      "每一天的努力都在为未来铺路！🌈",
      "静心学习，收获知识的果实！📚",
      "今天的付出，是明天的收获！🌱",
      "保持热爱，奔赴山海！⛰️",
      "学习使人进步，加油！💡",
      "愿你的努力都能开花结果！🌸",
      "书山有路勤为径，学海无涯苦作舟！🚀",
      "每一次专注都是对未来的投资！💫",
      "让知识成为你最闪亮的光芒！⭐",
      "坚持的人最美丽，奋斗的人最可爱！🌺"
    ];

    // 获取随机鼓励语
    function getRandomEncouragement() {
      return encouragements[Math.floor(Math.random() * encouragements.length)];
    }
  </script>
</body>

</html>